# Самодельный стратостат. Часть 3

![Vostok-4 view](images/vostok-4_header.jpg "Самодельный стратостат. Часть 3")

Те из вас, кто читал предыдущие части моей истории, сейчас наверняка пристально разглядывают эту картинку и у них в голове появляются вопросы. Если вы присоединились только к 3-й части - все равно запрыгивайте, будет интересно и будут ссылки на прошлые части. Как можно догадаться - мы снова это сделали. Мы запустили свой самодельный стратостат из жвачки и картофельных батареек, и привезли немного интересного из стратосферы. Хотите узнать почему это фото именно такое? Поехали!

## Вступление

[Самодельный стратостат. Часть 1](https://habr.com/ru/post/555070/)

[Самодельный стратостат. Часть 2](https://habr.com/ru/post/577184/)

Да потому что мы сделали запуск ночью... Мы, конечно, не планировали запуск ночью, но "человек предполагает, а COVID располагает"... Так что расписание наше пришлось подвинуть, пока все не перестали кашлять и запуск сдвинулся на будний день. А там у всех дневная работа, заботы и т.п. Перенести на ближайшие выходные не получилось уже из-за меня - мне надо было срочно улетать домой. В общем это был вечер буднего дня.

> По секрету скажу (я эту мысль никому из команды ранее не озвучивал, иначе меня засмеяли бы), что у меня была идея запустить ночью, *когда-нибудь*. Я, почему-то, думал, что GoPro вытащит неплохой ночной вид на видео. Но, как вы понимаете, не вытащила, хоть и снимала с максимальным для нее ISO 1600. Хотя фото это мне нравится - на нем Луна :-)

Все! На этом можно заканчивать. Ну ладно, ладно. Я расскажу как все было и почему все было именно так.

Для начала небольшое отступление для вновь подключившихся. Около года назад мы с друзьями решили собрать свое *нечто*, способное подняться на высоту 30+ км, записать там видео и некоторые данные, вроде влажности, температур, давления и т.п. Мы назвали это *самодельный стратостат*. В первой части статьи приведен подробный план постройки этого аппарата (все этапы). Во второй части мы учли некоторые ошибки прошлого и повторили запуск(-и). 3апускали мы 3 раза, всего было 4 шара, улетело из них на тот момент - 2. И вот, наш 4-й запуск, в который полетел, улетел и прилетел наш 5-й шар - **Vostok-4** (да-да, naming convention описан во второй части статьи).

Вцелом, всю нашу историю за прошедший год можно изобразить вот этой совершенной инфографикой:
![Vostok Launches](images/vostok_ytd_launches.png "Все запуски восток. Сезон 2020-2021")

Да, вы снова видите эту цифру: **35794м**. И на фотке из заголовка она, и тут она. Все верно. Но обо всем по порядку.

## Конструкция

### Общая конструкция

Хоть я и обещал в прошлый раз, что технических изменений не будет, но, как говорится - еще ни один план не пережил начало битвы. А битва у нас случилась с парашютом. Дело в том, что за все наши запуски наш самый первый парашют поистрепался. Я упоминал уже, что, даже после первого запуска, он немного надорвался на внутренней поверхности купола. Повреждение выло не критичным и мы запустились с ним еще раз. Это его и добило. Нет, посадка Vostok-3b была мягкой, но парашют окончательно пришел в негодность и мы решили его заменить.

*Почему-то* наш конструктор посчитал хорошей идеей вместо одного парашюта сделать два. Ну, на самом деле, аргумент его был весьма прост: больше парашютов - мягче посадка (суммарная площать поверхности, создающей сопротивление, ведь больше). Помогло это или почему не помогло обсудим в результатах. А сейчас очень важный нюанс: первый парашют был бесстропный, вторые два со стропами. И я вам наперед скажу: если не хотите проблем - со всей силы ищите бесстропные парашюты.

Итак, у нас 2 стропных парашюта, каждый из которых крепится своим фалом к горловине шара. Снизу, от строп парашютов идут независимые фалы к еще одному фалу, который уже крепится к полезной нагрузке. Схематично это выглядит так (масштаб не учтен):

![General scheme](images/general_scheme.png "Общая схема")

> Существует древняя истина: чем больше в системе элементов - тем чаще она ломается. Это правда, я про это знал и... ничего конструктору не сказал. Представленная схема креплений Vostok-4 сильно сложнее прошлых версий. Тут и фалов вагон, и парашютные стропы, и их соединения. В общем - так себе идея. Но проверить стоило.

Следующим изменением был сам шар - основа всей конструкции. Как вы могли заметить на инфографике, каждый раз мы запускали разные шары. На этот раз мы раздобыли у китайских коллег царь-шар массой **2 килограмма**. Это в 6 раз больше чем было у Vostok-3b. Ну и он не подвел.

Ссылка на шар: [aliexpress](https://aliexpress.ru/item/1822808425.html)

Заявленные характеристики следующие:

![Balloon parameters](images/balloon_parameters.png "Параметры шаров")

Да, по ссылке шары >2000г отсутствуют. Так что мы заказали тот что на 2кг, а потом уже, пообщавшись с продавцом, выяснили что можно заказать шарик и покруче. Стоит их пробовать или нет - решайте сами. Сразу скажу, что шар на 2кг обошелся нам примерно в 25000 руб. К тому же, у меня большие сомнения насчет возможности подъема выше 38км без реактивной тяги - уж очень мало там воздуха. Так что, если хотите наверняка - берите максимум 2кг.

### Полезная нагрузка

Тут без изменений. Ничего не убавили, ничего не добавили. Даже павербанки летали те же, что и в прошлый раз. Пролистываем.

## Программирование

А вот тут с изменениями :-)

Но с одной оговоркой: на Vostok-4 летала та же верси ПО, что и на Vostok-3b. Все изменения, описанные тут, сделаны по результатам анализа телеметрии Vostok-4 и эта версия еще никуда не летала! По этой же причине бранч не влит в мастер.

Вот предмет обсуждения: [bugfix/report_gaps](https://github.com/ArtemKiyashko/RpiProbeLogger/tree/bugfix/report_gaps)

А произошло следующее. В основном цикле есть такое условие:

```csharp
while (true)
{
    ...

    if (gpsData is not null || _reportService.ReportFileCreated)
    {
        //collect sensor data nad write report entity
    }
    Thread.Sleep(1000);
}
```

Я объяснял в первой части, что точка синхронизации всех параметров телеметрии - время, полученное по GPS. Соответственно, не имея данных GPS - нет смысл записывать отчет. Или есть? На самом деле есть, т.к. во-первых: нам не так уж и важно абсолютное время - достаточно относительного (просто записывать каждую секунду). Во-вторых: гораздо более удачной точкой синхронизации может стать высота, а не время. А высота у нас не только от GPS, но ее можно вычислить и по барометрической формуле (и мы это делали в первой статье). Но этот метод требует определенного оборудования за бортом. Например градусника, способного измерить очень низкие температуры (ниже -40C). Наш внешний градусник ограничен нижней планкой в -40C, а внутренний - подвержен влиянию нашей системы климатизации (нагревается от RPI и охлаждается забортным воздухом).

В общем, данные GPS не сильно важны (но очень желательны), оттого появилось это `|| _reportService.ReportFileCreated`. Так уж получилось, что хоть 1 раз, но GPS нам необходим - чтобы сгенерировать имя файла отчета ¯\\_(ツ)_/¯ А дальше уже можно и без GPS, и все должно быть хорошо.

Но, листая телеметрию с этого запуска, я обнаружил следующее:

![Telemetry Gap](images/telemetry_gap.png "Разрыв телеметрии")

Видите, видите? "Расстояние" между 2-я этими соседними строчками немного больше чем 1 секунда. Оно почти **полчаса!** Откуда? Что? Как? Да, очевидно что мы потеряли GPS на какое-то время, но ведь, следуя условию в основном цикле, мы все равно должны были записать данные с сенсоров. Причина оказалась совсем детской - `NullReferenceException` вот тут:

![App Fix](images/fix_itself.png "NRE Fix")

Мда... Собственно, это и есть весь фикс. Но этот случай вынудил меня написать юнит-тесты для всего этого хозяйства, чему и посвящено 99% изменений в бранче с фиксом. Сейчас там конечно не *full coverage*, но основные моменты я покрыл. Сами тесты (если интересно) посмотрите в [репозитории](https://github.com/ArtemKiyashko/RpiProbeLogger/tree/bugfix/report_gaps), а тут мы посмотрим на результаты.

До фикса:

![No Fix](images/before_fix.png "Без фикса")

После фикса:

![No Fix](images/after_fix.png "С фиксом")

Ну и запуск теста с записью в файл:

![No Fix](images/fix_result.png "Отчет после фикса")

Видим, что данных GPS нет, но остальные данные на месте. Выпили ромашковый чай и двинули дальше.

## Бухгалтерия

Тут почти все идеально, наконец-то :-)

ТАБЛИЦА!

Траты были только на *расходники*: шар и гелий. Ну и на новые парашюты. Теоретически, их тоже можно вписать в расходники, но чуть более *long-term*. С другой стороны - так можно все что угодно вписать в расходники. Ведь ни что не вечно. Тем не менее, мы не рассматривали конструкцию как "полностью переиспользуемую" на протяжении долго времени. А для нескольких запусков одного нормального парашюта вам должно хватить. Едиственное, что вы 100% будете докупать - это шар и гелий.

## Подготовка к запуску

Этот пункт был подробно рассмотрен в первой части статьи, с тех пор механика поиска места запуска не изменилась.

Но! Тут хочу отметить один важный момент: меня много раз в комментариях дергали вопросом обеспечения безопасности полетов и, в целом, "легализации" этого занятия. Как то: получение разрешения на использование воздушного пространства и подача плана полета в организацию воздушного движения. В прошлый раз я ответил в коментариях, почему не могу сейчас описать этот процесс в статье. Эта же причина сохранилась и по сей день, но мы над этим работаем и все выглядит так, будто бы дело сдвинулось с мертвой точки. Да, планы мы всегда (!) подавали, но процесс их подачи на данный момент непригоден для описания в виде "инструкции". А так как это очень важная часть всей нашей затеи - мы решили довести этот вопрос до пригодного состояния и выложить это как небольшую, но отдельную часть серии статей про самодельный стратостат. Как минимум это сильно облегчит поиск этой информации для тех, кто решит повторить этот путь. Так что ждите, будет отдельно и по делу про "ОрВД, ЕЦ, СЦ и ФГУП" и прочие генераторы случайных букв в российских госструктурах.

![SPB SZ GKOVD](images/spb_sz.png "СПБЦ ОВД")

## Запуск

## Поиск и спасение

## Результаты

## Видео

## Выводы